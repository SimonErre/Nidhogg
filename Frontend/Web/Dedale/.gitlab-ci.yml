variables:
  PROJECT_PATH: "Frontend/Web/Dedale/src-tauri"
  WEB_PATH: "Frontend/Web/Dedale"
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  npm_config_cache: $CI_PROJECT_DIR/.npm

image: $CI_REGISTRY_IMAGE:latest

stages:
  - build-image
  - quality
  - test
  - release
  - deploy

# build l'image custom
build_ci_image:
  stage: build-image
  image: docker:latest
  services:
    - name: docker:dind
      command: ["--tls=false"]
  rules:
    - changes:
        - Frontend/Web/Dedale/Dockerfile
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  before_script:
    - until docker info; do sleep 1; done
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Building image $CI_REGISTRY_IMAGE:latest"
    - docker build -t $CI_REGISTRY_IMAGE:latest -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -f $WEB_PATH/Dockerfile .
    - docker push $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA

.cache_cargo: &cache_cargo
  key: "${CI_COMMIT_REF_SLUG}-cargo"
  paths:
    - .cargo/registry/
    - .cargo/git/
    - $PROJECT_PATH/target/
  policy: pull-push

# Cache npm - √©vite de re-t√©l√©charger les packages Node.js
.cache_npm: &cache_npm
  key: "${CI_COMMIT_REF_SLUG}-npm"
  paths:
    - .npm/
    - $WEB_PATH/node_modules/
  policy: pull-push

# ===========================================
# QUALITY JOBS
# ===========================================
check_rust_quality:
  stage: quality
  rules:
    - if: $CI_COMMIT_BRANCH != "main"
  cache:
    - <<: *cache_cargo
  script:
    - cd $PROJECT_PATH
    - mkdir -p reports
    - cargo fmt --all -- --check 2>&1 | tee reports/cargoFmt_report.txt
    - cargo clippy --all-targets --all-features -- -D warnings 2>&1 | tee reports/clippy_report.txt
  after_script:
    - cd $PROJECT_PATH
    - rm -rf target/debug/incremental target/debug/.fingerprint
    - find target -name "*.lock" -type f -delete 2>/dev/null || true
  artifacts:
    when: always
    paths:
      - $PROJECT_PATH/reports/
    expire_in: 1 week
  allow_failure: false

lint_frontend:
  stage: quality
  rules:
    - if: $CI_COMMIT_BRANCH != "main"
  cache:
    - <<: *cache_npm
  script:
    - cd $WEB_PATH
    - npm ci --prefer-offline
    - mkdir -p $CI_PROJECT_DIR/$PROJECT_PATH/reports
    - npm run lint 2>&1 | tee $CI_PROJECT_DIR/$PROJECT_PATH/reports/lint_report.txt
  artifacts:
    when: always
    paths:
      - $PROJECT_PATH/reports/
    expire_in: 1 week
  allow_failure: false

# ===========================================
# TEST JOBS
# ===========================================
test_e2e:
  stage: test
  rules:
    - if: $CI_COMMIT_BRANCH == "web" || $CI_COMMIT_BRANCH == "develop"
  needs:
    - job: check_rust_quality
    - job: lint_frontend
  cache:
    - <<: *cache_npm
    - <<: *cache_cargo
    - key: "${CI_COMMIT_REF_SLUG}-webdriver"
      paths:
        - $PROJECT_PATH/webdriver/webdriverio/node_modules/
      policy: pull-push
  script:
    # Build for E2E tests
    - cd $WEB_PATH
    - npm ci --prefer-offline
    - npm run tauri build -- --no-bundle --verbose

    # Run E2E tests
    - cd $CI_PROJECT_DIR/$PROJECT_PATH/webdriver/webdriverio
    - npm ci --prefer-offline
    - mkdir -p reports screenshots logs
    - xvfb-run -a -s "-screen 0 1920x1080x24" npm run test
  after_script:
    - cd $PROJECT_PATH
    - rm -rf target/debug/incremental target/debug/.fingerprint
    - find target -name "*.lock" -type f -delete 2>/dev/null || true
  artifacts:
    when: always
    paths:
      - $PROJECT_PATH/webdriver/webdriverio/reports/
      - $PROJECT_PATH/webdriver/webdriverio/screenshots/
      - $PROJECT_PATH/webdriver/webdriverio/logs/
    expire_in: 1 week
  allow_failure: true

test_front:
  stage: test
  rules:
    - if: $CI_COMMIT_BRANCH == "web" || $CI_COMMIT_BRANCH == "develop"
  cache:
    - <<: *cache_npm
  script:
    - cd $WEB_PATH
    - npm ci --prefer-offline
    - npm test -- --run --reporter=default --reporter=junit --outputFile=$CI_PROJECT_DIR/$PROJECT_PATH/reports/junit.xml
  artifacts:
    when: always
    paths:
      - $PROJECT_PATH/reports/
    expire_in: 1 week
  allow_failure: false

test_backend:
  stage: test
  rules:
    - if: $CI_COMMIT_BRANCH == "web" || $CI_COMMIT_BRANCH == "develop"
  cache:
    - <<: *cache_cargo
  script:
    - cd $PROJECT_PATH
    - mkdir -p reports
    - cargo test --all --verbose 2>&1 | tee reports/cargoTest_report.txt
  after_script:
    - cd $PROJECT_PATH
    - rm -rf target/debug/incremental target/debug/.fingerprint
    - find target -name "*.lock" -type f -delete 2>/dev/null || true
  artifacts:
    when: always
    paths:
      - $PROJECT_PATH/reports/
    expire_in: 1 week
  allow_failure: false

# ===========================================
# RELEASE JOBS
# ===========================================
build_and_upload_windows:
  stage: release
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  cache:
    - key: "${CI_COMMIT_REF_SLUG}-cargo-windows"
      paths:
        - .cargo/registry/index/
        - .cargo/registry/cache/
        - .cargo/git/db/
      policy: pull-push
    - <<: *cache_npm
  script:
    # 1. Installation de Curl (si pas pr√©sent dans ton image Docker)
    - apt-get update && apt-get install -y curl || true

    # 2. Build de l'application
    - cd $WEB_PATH
    - npm ci --prefer-offline
    - npm run tauri build -- --runner cargo-xwin --target x86_64-pc-windows-msvc --verbose

    # 3. Upload DIRECT vers le Registre de Paquets
    - cd $CI_PROJECT_DIR
    - INSTALLER_PATH=$(find $PROJECT_PATH/target/x86_64-pc-windows-msvc/release/bundle/nsis/ -name "*.exe" | head -n 1)
    - INSTALLER_NAME="dedale-installer-v1.0.$CI_PIPELINE_IID.exe"
    - echo "Uploading $INSTALLER_PATH as $INSTALLER_NAME..."

    - |
      curl --header "JOB-TOKEN: $CI_JOB_TOKEN" \
           --upload-file "$INSTALLER_PATH" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/dedale/1.0.$CI_PIPELINE_IID/$INSTALLER_NAME"

# ===========================================
# DEPLOY JOBS
# ===========================================
# --- GITLAB RELEASE ---
release_windows:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  needs:
    - job: build_and_upload_windows
  script:
    - echo "Creating release for build $CI_PIPELINE_IID"
  release:
    tag_name: "v1.0.$CI_PIPELINE_IID"
    name: "Dedale v1.0.$CI_PIPELINE_IID"
    description: |
      ## üì¶ Version 1.0.$CI_PIPELINE_IID

      **Build:** $CI_PIPELINE_IID
      **Commit:** $CI_COMMIT_SHORT_SHA

      ### T√©l√©chargement
      [T√©l√©charger l'installateur Windows](https://gitlab.com/${CI_PROJECT_PATH}/-/package_files/...)
      *(Le lien direct est dans les Assets ci-dessous)*

    assets:
      links:
        - name: "Dedale-Windows-Installer.exe"
          url: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/dedale/1.0.$CI_PIPELINE_IID/dedale-installer-v1.0.$CI_PIPELINE_IID.exe"
          link_type: "package"
